name: Atualizar Calendário CS2

on:
  schedule:
    - cron: "*/10 * * * *" # Executa a cada 10 minutos
  workflow_dispatch: # Permite execução manual

permissions:
  contents: write   # Necessário para commit/push
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout do repositório
      - name: Checkout código
        uses: actions/checkout@v4

      # 2) Configura Python
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3) Instala Google Chrome (necessário para Selenium)
      - name: Instalar Google Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: 'stable'

      # 4) Instala dependências Python
      - name: Instalar dependências Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5) Executa o script Python
      - name: Executar script Python
        run: python generate_ics.py

      # 6) Commita calendar.ics E state.json (persistência do cursor)
      - name: Commit e Push do calendário e estado (se houver mudanças)
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          # Adiciona os arquivos gerados/persistidos
          git add calendar.ics state.json

          if git diff --cached --quiet; then
            echo "✅ Nenhuma mudança detectada - commit ignorado"
          else
            git commit -m "Atualizar ICS CS2 - $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            git push
            echo "✅ Mudanças detectadas e commitadas com sucesso"
          fi
