name: Atualizar calendÃ¡rio HLTV

on:
  schedule:
    # Todo dia Ã s 06:00 UTC (~03:00 BrasÃ­lia)
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write  # Permite push usando GITHUB_TOKEN
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Instalar dependÃªncias Python
        run: |
          python -m pip install --upgrade pip
          pip install ics requests pytz

      - name: Gerar calendar.ics apenas com jogos futuros de times brasileiros (sem emojis)
        run: |
          python <<'EOF'
          import requests
          from ics import Calendar
          import re
          from datetime import datetime, timezone

          BRAZILIAN_TEAMS = ["FURIA", "paiN", "MIBR", "Imperial", "Fluxo", "O PLANO", "Sharks", "RED Canids"]

          # FunÃ§Ã£o para remover emojis e caracteres especiais
          def remove_emojis(text: str) -> str:
              return re.sub(r'[^\x00-\x7F]+', '', text)

          # Data/hora atual em UTC
          now_utc = datetime.now(timezone.utc)

          # Baixar ICS oficial do HLTV.Events
          url = "https://calendar.hltv.events/events.ics"
          print(f"ðŸ”¹ Baixando ICS oficial do HLTV.Events: {url}")
          response = requests.get(url)
          response.raise_for_status()
          print(f"ðŸ”¹ Status code da requisiÃ§Ã£o: {response.status_code}")

          source_calendar = Calendar(response.text)
          my_calendar = Calendar()

          # Filtrar eventos de times brasileiros futuros
          for event in source_calendar.events:
              if event.begin is None:
                  continue  # Ignora eventos sem data
              event_time = event.begin
              if event_time.tzinfo is None:
                  event_time = event_time.replace(tzinfo=timezone.utc)  # assume UTC
              if any(team in event.name for team in BRAZILIAN_TEAMS) and event_time > now_utc:
                  my_calendar.events.add(event)
                  print(f"âœ… Adicionado: {remove_emojis(event.name)} em {event.begin}")

          # Salvar ICS filtrado sem emojis
          with open("calendar.ics", "w", encoding="utf-8") as f:
              for line in my_calendar.serialize_iter():
                  f.write(remove_emojis(line) + "\n")

          print("ðŸ”¹ calendar.ics gerado com sucesso!")
          EOF

      - name: Commit e publicar calendar.ics direto na main
        run: |
          if [[ `git status --porcelain` ]]; then
            echo "ðŸ”¹ Configurando Git user"
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"

            echo "ðŸ”¹ Adicionando calendar.ics"
            git add calendar.ics

            echo "ðŸ”¹ Commitando alteraÃ§Ãµes"
            git commit -m "Atualizar ICS HLTV"

            echo "ðŸ”¹ Push para main"
            git push
          else
            echo "Nenhuma mudanÃ§a detectada."
          fi
