name: Atualizar calendário HLTV

on:
  schedule:
    - cron: '0 6 * * *'  # Todo dia às 06:00 UTC (~03:00 Brasília)
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Instalar dependências Python
        run: |
          python -m pip install --upgrade pip
          pip install ics requests pytz

      - name: Gerar calendar.ics apenas com jogos futuros de times brasileiros (sem emojis)
        run: |
          python <<'EOF'
          import requests
          from ics import Calendar
          import re
          from datetime import datetime, timezone

          BRAZILIAN_TEAMS = ["FURIA", "paiN", "MIBR", "Imperial", "Fluxo", "O PLANO", "Sharks", "RED Canids"]

          # Função para remover emojis e caracteres especiais
          def remove_emojis(text: str) -> str:
              return re.sub(r'[^\x00-\x7F]+', '', text)

          now_utc = datetime.now(timezone.utc)

          url = "https://calendar.hltv.events/events.ics"
          response = requests.get(url)
          response.raise_for_status()

          source_calendar = Calendar(response.text)
          my_calendar = Calendar()

          for event in source_calendar.events:
              if event.begin is None:
                  continue
              event_time = event.begin
              if event_time.tzinfo is None:
                  event_time = event_time.replace(tzinfo=timezone.utc)
              if any(team in event.name for team in BRAZILIAN_TEAMS) and event_time > now_utc:
                  my_calendar.events.add(event)

          # Salvar na raiz da branch main para GitHub Pages
          with open("calendar.ics", "w", encoding="utf-8") as f:
              for line in my_calendar.serialize_iter():
                  f.write(remove_emojis(line) + "\n")
          EOF

      - name: Commit e publicar calendar.ics
        run: |
          if [[ `git status --porcelain` ]]; then
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"

            git add calendar.ics
            git commit -m "Atualizar ICS HLTV"
            git push
          else
            echo "Nenhuma mudança detectada."
